name: VPS
on:
  workflow_dispatch:
  schedule:
    - cron: '50 */5 * * *'  # ูู 5 ุณุงุนุงุช ู50 ุฏูููุฉ

jobs:
  vps-with-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 350
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        
      - name: Install Essential Packages (Fixed)
        run: |
          echo "๐ฆ ุชุซุจูุช ุงูุญุฒู ุงูุฃุณุงุณูุฉ ููุท..."
          
          # ุงูุชุญุฏูุซ ุงูุฃุณุงุณู
          sudo apt update -y
          sudo apt upgrade -y -q
          
          # ุงูุญุฒู ุงูุฃุณุงุณูุฉ ููุท (ููุฌูุฏุฉ ูุนูุงู)
          sudo apt install -y \
            python3 \
            python3-pip \
            python3-venv \
            git \
            curl \
            wget \
            htop \
            nano \
            vim \
            tmux \
            build-essential \
            software-properties-common \
            openssh-server \
            net-tools \
            iputils-ping \
            traceroute \
            jq \
            bc \
            screen \
            ffmpeg \
            tree \
            locate \
            mlocate \
            gcc \
            g++ \
            make \
            cmake \
            libssl-dev \
            libffi-dev \
            zip \
            unzip \
            p7zip \
            fail2ban \
            ufw \
            nginx \
            sqlite3 \
            inotify-tools
          
          echo "โ ุชู ุชุซุจูุช ุงูุญุฒู ุงูุฃุณุงุณูุฉ ุจูุฌุงุญ!"
          
      - name: Install Python Libraries
        run: |
          echo "๐ ุชุซุจูุช ููุชุจุงุช ุจุงูุซูู..."
          pip3 install --upgrade pip
          
          # ููุชุจุงุช ุจุงูุซูู ุงูุฃุณุงุณูุฉ ููุท
          pip3 install \
            numpy \
            pandas \
            matplotlib \
            requests \
            beautifulsoup4 \
            pillow \
            python-telegram-bot \
            pyautogui \
            schedule \
            python-dotenv \
            psutil \
            aiohttp \
            asyncio
          
          echo "โ ุชู ุชุซุจูุช ููุชุจุงุช ุจุงูุซูู!"
          
      - name: Configure SSH Server
        run: |
          echo "๐ ุฅุนุฏุงุฏ ุฎุงุฏู SSH..."
          sudo systemctl enable ssh
          sudo systemctl start ssh
          
          # ุชุนููู ูููุฉ ูุฑูุฑ ุขููุฉ
          SSH_PASSWORD="VPS@Secure2024"
          echo "root:$SSH_PASSWORD" | sudo chpasswd
          
          # ุชูููู SSH
          sudo tee -a /etc/ssh/sshd_config << EOF
          PermitRootLogin yes
          PasswordAuthentication yes
          ClientAliveInterval 60
          ClientAliveCountMax 3
          X11Forwarding yes
          AllowTcpForwarding yes
          GatewayPorts yes
          EOF
          
          sudo systemctl restart ssh
          echo "โ SSH ุฌุงูุฒ: root@[IP] | ูููุฉ ุงููุฑูุฑ: $SSH_PASSWORD"
          
      - name: Install & Configure Tailscale
        run: |
          echo "๐ ุชุซุจูุช ูุชูููู Tailscale..."
          
          # ุชุซุจูุช Tailscale
          curl -fsSL https://tailscale.com/install.sh | sh
          
          # ุชุดุบูู Tailscale
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=github-vps-$(date +%Y%m%d) \
            --accept-routes=true \
            --accept-dns=true
          
          # ุงูุญุตูู ุนูู IP
          TAILSCALE_IP=$(tailscale ip -4 | head -n1)
          echo "๐ฏ IP ุงูุฎุงุต ุจู: $TAILSCALE_IP"
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
          
          # ุญูุธ ุงูู IP ูู ููู
          echo $TAILSCALE_IP > /tmp/vps_ip.txt
          echo "โ ุชู ุญูุธ ุงูู IP: $TAILSCALE_IP"
          
      - name: Setup Telegram Bot
        run: |
          echo "๐ค ุฅุนุฏุงุฏ ุจูุช ุงูุชููุฌุฑุงู..."
          
          # ุฅูุดุงุก ูุฌูุฏ ุงูุจูุช
          mkdir -p /root/tg_bot
          cd /root/tg_bot
          
          # ููุฏ ุงูุจูุช ุงูุจุณูุท ูุงููุถููู
          cat << 'EOF' > bot.py
          import os
          import logging
          import psutil
          import subprocess
          from telegram import Update
          from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
          
          # ุฅุนุฏุงุฏุงุช ุงูุจูุช
          TOKEN = "8541707577:AAHivkWH7RdHhKr8zXSuL_roy245LmNYyRo"
          ADMIN_ID = 7259620384
          
          # ุฅุนุฏุงุฏ ุงูุชุณุฌูู
          logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
          
          async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
              await update.message.reply_text("๐ VPS Bot Started!\nุงุณุชุฎุฏู /help ููุฃูุงูุฑ")
          
          async def help_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
              help_text = """
              ๐ ุงูุฃูุงูุฑ ุงููุชุงุญุฉ:
              
              /start - ุจุฏุก ุงูุจูุช
              /ip - ุนุฑุถ IP ุงูุณูุฑูุฑ
              /status - ุญุงูุฉ ุงููุธุงู
              /ssh - ูุนูููุงุช ุงูุงุชุตุงู
              /restart - ุฅุนุงุฏุฉ ุงูุชุดุบูู (ูููุณุคูู)
              """
              await update.message.reply_text(help_text)
          
          async def ip_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
              try:
                  result = subprocess.run(['tailscale', 'ip', '-4'], capture_output=True, text=True)
                  ip = result.stdout.strip()
                  if ip:
                      await update.message.reply_text(f"๐ IP ุงูุณูุฑูุฑ: `{ip}`\n\n๐ ููุงุชุตุงู:\n```bash\nssh root@{ip}\n```")
                  else:
                      await update.message.reply_text("โ ูู ูุชู ุงูุนุซูุฑ ุนูู IP")
              except:
                  await update.message.reply_text("โ ุญุฏุซ ุฎุทุฃ")
          
          async def status_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
              cpu = psutil.cpu_percent()
              mem = psutil.virtual_memory()
              disk = psutil.disk_usage('/')
              
              status_text = f"""
              ๐ ุญุงูุฉ ุงููุธุงู:
              
              CPU: {cpu}%
              ุงูุฐุงูุฑุฉ: {mem.percent}%
              ุงูุชุฎุฒูู: {disk.percent}%
              
              โ ุงููุธุงู ูุนูู ุจุดูู ุทุจูุนู
              """
              await update.message.reply_text(status_text)
          
          async def ssh_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
              result = subprocess.run(['tailscale', 'ip', '-4'], capture_output=True, text=True)
              ip = result.stdout.strip()
              if ip:
                  await update.message.reply_text(f"๐ ูุนูููุงุช SSH:\n\n๐ IP: `{ip}`\n๐ค User: `root`\n๐ Pass: `VPS@Secure2024`")
              else:
                  await update.message.reply_text("โ ูู ูุชู ุงูุนุซูุฑ ุนูู IP")
          
          async def restart_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
              if update.effective_user.id == ADMIN_ID:
                  subprocess.run(['systemctl', 'restart', 'ssh'])
                  await update.message.reply_text("โ ุชู ุฅุนุงุฏุฉ ุชุดุบูู ุงูุฎุฏูุงุช")
              else:
                  await update.message.reply_text("โ ุบูุฑ ูุณููุญ")
          
          async def main():
              app = Application.builder().token(TOKEN).build()
              
              app.add_handler(CommandHandler("start", start))
              app.add_handler(CommandHandler("help", help_cmd))
              app.add_handler(CommandHandler("ip", ip_cmd))
              app.add_handler(CommandHandler("status", status_cmd))
              app.add_handler(CommandHandler("ssh", ssh_cmd))
              app.add_handler(CommandHandler("restart", restart_cmd))
              
              await app.initialize()
              await app.start()
              await app.updater.start_polling()
              
              # ุฅุจูุงุก ุงูุจูุช ูุนูู
              import asyncio
              await asyncio.Event().wait()
          
          if __name__ == '__main__':
              import asyncio
              asyncio.run(main())
          EOF
          
          # ุชุดุบูู ุงูุจูุช ูู ุงูุฎูููุฉ
          nohup python3 bot.py > bot.log 2>&1 &
          
          echo "โ ุชู ุชุดุบูู ุจูุช ุงูุชููุฌุฑุงู!"
          
      - name: Setup Auto Services
        run: |
          echo "โ๏ธ ุฅุนุฏุงุฏ ุงูุฎุฏูุงุช ุงูุชููุงุฆูุฉ..."
          
          # ุฎุฏูุฉ ุงููุฑุงูุจุฉ ุงูุชููุงุฆูุฉ
          cat << 'EOF' > /root/monitor.sh
          #!/bin/bash
          
          # ุฅุฑุณุงู ุฑุณุงูุฉ ุฅูู ุงูุชููุฌุฑุงู
          send_tg() {
              curl -s -X POST "https://api.telegram.org/bot8541707577:AAHivkWH7RdHhKr8zXSuL_roy245LmNYyRo/sendMessage" \
                  -d "chat_id=7259620384" \
                  -d "text=$1" \
                  -d "parse_mode=Markdown" > /dev/null
          }
          
          # ุฅุฑุณุงู ุฑุณุงูุฉ ุงูุจุฏุก
          send_tg "๐ *VPS Started Successfully!*\\n\\nโ System is ready\\n๐ค Bot is online\\n\\nUse /ip to get server IP"
          
          while true; do
              # ุงูุชุญูู ูู Tailscale
              if ! tailscale status > /dev/null 2>&1; then
                  sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --reset
                  send_tg "๐ *Tailscale Reconnected*"
              fi
              
              # ุงูุชุญูู ูู SSH
              if ! systemctl is-active --quiet ssh; then
                  sudo systemctl restart ssh
              fi
              
              sleep 60
          done
          EOF
          
          chmod +x /root/monitor.sh
          nohup /root/monitor.sh > /root/monitor.log 2>&1 &
          
          echo "โ ุชู ุชุดุบูู ุฎุฏูุฉ ุงููุฑุงูุจุฉ!"
          
      - name: Display Connection Info
        run: |
          echo " "
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "        ๐ VPS READY FOR USE!            "
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo " "
          echo "๐ก ููุงุชุตุงู ุนุจุฑ SSH:"
          echo "   ssh root@$TAILSCALE_IP"
          echo "   ูููุฉ ุงููุฑูุฑ: VPS@Secure2024"
          echo " "
          echo "๐ค ุจูุช ุงูุชููุฌุฑุงู:"
          echo "   Token: 8541707577:AAHivkWH7RdHhKr8zXSuL_roy245LmNYyRo"
          echo "   Admin ID: 7259620384"
          echo "   ุงูุฃูุงูุฑ: /start /ip /status /ssh"
          echo " "
          echo "โฐ ุงููุฏุฉ: 5 ุณุงุนุงุช ู 50 ุฏูููุฉ"
          echo "๐ ุงูุชุฌุฏูุฏ: ูู 5 ุณุงุนุงุช ุชููุงุฆูุงู"
          echo " "
          echo "โ ูู ุดูุก ุฌุงูุฒ ููุชุดุบูู!"
          echo " "
          
      - name: Keep VPS Alive
        run: |
          echo "โณ ุงูุณูุฑูุฑ ุณูุนูู ููุฏุฉ 350 ุฏูููุฉ..."
          echo "๐ ุงูุฌูุณุฉ ุงูุชุงููุฉ ุชุจุฏุฃ ุชููุงุฆูุงู ูุจู ุงูููุงูุฉ"
          
          # ุงูุชุธุงุฑ ุญุชู ููุงูุฉ ุงูููุช
          sleep 21000  # 350 ุฏูููุฉ
          
          echo "โ ุงูุชูุช ุงูุฌูุณุฉ. ุงูุฌูุณุฉ ุงูุชุงููุฉ ุชุจุฏุฃ ูุฑูุจุงู..."
