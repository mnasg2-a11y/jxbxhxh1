name: Permanent-VPS-Bot-Ready
on:
  workflow_dispatch:
  schedule:
    - cron: '50 */5 * * *'  # ÙƒÙ„ 5 Ø³Ø§Ø¹Ø§Øª Ùˆ50 Ø¯Ù‚ÙŠÙ‚Ø©

jobs:
  vps-with-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 350
    
    steps:
      - name: Checkout & Setup
        uses: actions/checkout@v3
        
      - name: Install ALL Libraries & Tools
        run: |
          echo "ğŸ“¦ Installing all required packages..."
          
          # Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
          sudo apt update -y
          sudo apt upgrade -y
          
          # Ù„ØºØ§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© ÙˆØ§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
          sudo apt install -y \
            python3 python3-pip python3-venv python3-dev \
            nodejs npm \
            git curl wget htop nano vim tmux \
            build-essential software-properties-common \
            zip unzip rar unrar p7zip \
            net-tools iputils-ping traceroute \
            jq bc ncdu screen \
            ffmpeg imagemagick \
            tree locate mlocate \
            gcc g++ make cmake \
            libssl-dev libffi-dev zlib1g-dev \
            libsqlite3-dev libreadline-dev \
            libncursesw5-dev libgdbm-dev libnss3-dev \
            libbz2-dev liblzma-dev tk-dev uuid-dev \
            libbluetooth-dev libexpat1-dev \
            libmpdec-dev libgeos-dev
            
          # Python libraries Ø§Ù„Ø´Ø§Ù…Ù„Ø©
          pip3 install --upgrade pip
          pip3 install \
            numpy pandas matplotlib seaborn \
            scipy scikit-learn tensorflow torch \
            django flask fastapi \
            requests beautifulsoup4 selenium \
            pillow opencv-python \
            telegram python-telegram-bot \
            pyautogui pywhatkit \
            pandas google-api-python-client \
            pandas yfinance alpaca-trade-api \
            ccxt websockets \
            aiohttp asyncio \
            pandas-ta ta-lib \
            schedule python-dotenv \
            python-multipart uvicorn
            
          # Node.js libraries
          npm install -g \
            npm-check-updates \
            pm2 \
            nodemon \
            express-generator
            
          # Ø£Ø¯ÙˆØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©
          sudo apt install -y \
            postgresql-client mysql-client \
            redis-tools mongodb-clients \
            apt-transport-https ca-certificates \
            gnupg-agent software-properties-common \
            docker.io docker-compose \
            fail2ban ufw \
            nginx apache2 \
            sqlite3 \
            inotify-tools \
            glances
            
          echo "âœ… All packages installed successfully!"
          
      - name: Configure SSH
        run: |
          sudo apt install -y openssh-server
          sudo systemctl enable ssh
          sudo systemctl start ssh
          
          # ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ±Ù‡Ø§)
          NEW_PASS="Admin@Secure123"
          echo "root:$NEW_PASS" | sudo chpasswd
          
          # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª SSH Ø¢Ù…Ù†Ø©
          sudo tee -a /etc/ssh/sshd_config << EOF
          PermitRootLogin yes
          PasswordAuthentication yes
          ClientAliveInterval 60
          ClientAliveCountMax 3
          X11Forwarding yes
          AllowTcpForwarding yes
          GatewayPorts yes
          EOF
          
          sudo systemctl restart ssh
          echo "âœ… SSH Ready: root@[IP] | Password: $NEW_PASS"
          
      - name: Install & Setup Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          
          # ØªØ´ØºÙŠÙ„ Tailscale Ù…Ø¹ Ù‡ÙˆÙŠØ© Ø«Ø§Ø¨ØªØ©
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=perm-vps-$(date +%m%d) \
            --advertise-tags=tag:vps-bot \
            --accept-routes=true \
            --accept-dns=true \
            --reset
          
          TAILSCALE_IP=$(tailscale ip -4 | head -n1)
          echo "ğŸ¯ Your Permanent IP: $TAILSCALE_IP"
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
          echo "IP=$TAILSCALE_IP" > /tmp/vps_ip.txt
          
      - name: Setup Telegram Bot
        run: |
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¨ÙˆØª
          mkdir -p /root/telegram_bot
          cd /root/telegram_bot
          
          # ÙƒØªØ§Ø¨Ø© ÙƒÙˆØ¯ Ø§Ù„Ø¨ÙˆØª
          cat << 'EOF' > bot.py
          import os
          import logging
          from telegram import Update
          from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
          
          # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª
          TOKEN = "8541707577:AAHivkWH7RdHhKr8zXSuL_roy245LmNYyRo"
          ADMIN_ID = 7259620384
          
          # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
          logging.basicConfig(
              format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
              level=logging.INFO
          )
          
          async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
              user = update.effective_user
              await update.message.reply_text(
                  f"Ù…Ø±Ø­Ø¨Ø§Ù‹ {user.first_name}! ğŸ‘‹\n"
                  f"Ø£Ù†Ø§ Ø¨ÙˆØª Ù…Ø±Ø§Ù‚Ø¨Ø© VPS Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ.\n"
                  f"Ø§Ø³ØªØ®Ø¯Ù… /help Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©."
              )
          
          async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
              help_text = """
              ğŸ“‹ **Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø±:**
              
              /start - Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª
              /status - Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Ø¯Ù…
              /ip - Ø¹Ø±Ø¶ IP Ø§Ù„Ø®Ø§Ø¯Ù…
              /info - Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
              /restart - Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª
              /ssh - Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ SSH
              /tailscale - Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Tailscale
              /update - ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù…
              /speedtest - Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø±Ø¹Ø©
              /backup - Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
              
              âš¡ **Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù†Ø¸Ø§Ù…:**
              /cpu - Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬
              /ram - Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°Ø§ÙƒØ±Ø©
              /disk - Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ†
              /network - Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ø¨ÙƒØ©
              /processes - Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
              /logs - Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
              """
              await update.message.reply_text(help_text)
          
          async def status_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
              import psutil
              import subprocess
              
              # Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
              cpu_percent = psutil.cpu_percent(interval=1)
              memory = psutil.virtual_memory()
              disk = psutil.disk_usage('/')
              
              # Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ©
              result = subprocess.run(['tailscale', 'ip', '-4'], capture_output=True, text=True)
              tailscale_ip = result.stdout.strip() if result.returncode == 0 else "ØºÙŠØ± Ù…ØªØµÙ„"
              
              status_text = f"""
              ğŸ“Š **Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Ø¯Ù…:**
              
              ğŸ–¥ï¸ **Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬:** {cpu_percent}%
              ğŸ’¾ **Ø§Ù„Ø°Ø§ÙƒØ±Ø©:** {memory.percent}% ({memory.used // (1024**3)}GB / {memory.total // (1024**3)}GB)
              ğŸ’¿ **Ø§Ù„ØªØ®Ø²ÙŠÙ†:** {disk.percent}% ({disk.used // (1024**3)}GB / {disk.total // (1024**3)}GB)
              
              ğŸŒ **Ø´Ø¨ÙƒØ© Tailscale:** {tailscale_ip}
              â° **Ù…Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„:** {psutil.boot_time()}
              
              âœ… **Ø§Ù„Ø­Ø§Ù„Ø©:** Ù†Ø´Ø· ÙˆØ¬Ø§Ù‡Ø²
              """
              await update.message.reply_text(status_text)
          
          async def ip_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
              import subprocess
              
              result = subprocess.run(['tailscale', 'ip', '-4'], capture_output=True, text=True)
              if result.returncode == 0:
                  ip = result.stdout.strip()
                  await update.message.reply_text(f"ğŸŒ **IP Ø§Ù„Ø®Ø§Ø¯Ù…:** `{ip}`\n\nğŸ“¡ **Ù„Ù„Ø§ØªØµØ§Ù„:**\n```bash\nssh root@{ip}\n```\nğŸ”‘ **ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:** Admin@Secure123")
              else:
                  await update.message.reply_text("âŒ ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ IP")
          
          async def ssh_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
              import subprocess
              
              result = subprocess.run(['tailscale', 'ip', '-4'], capture_output=True, text=True)
              if result.returncode == 0:
                  ip = result.stdout.strip()
                  await update.message.reply_text(
                      f"ğŸ” **Ù…Ø¹Ù„ÙˆÙ…Ø§Øª SSH:**\n\n"
                      f"ğŸ“ **Host:** `{ip}`\n"
                      f"ğŸ‘¤ **User:** `root`\n"
                      f"ğŸ”‘ **Password:** `Admin@Secure123`\n\n"
                      f"ğŸ“Ÿ **Ù„Ù„Ø§ØªØµØ§Ù„:**\n```bash\nssh root@{ip}\n```\n"
                      f"ğŸ’¾ **Ø£Ùˆ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±:**\n```bash\nsshpass -p 'Admin@Secure123' ssh root@{ip}\n```"
                  )
              else:
                  await update.message.reply_text("âŒ ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª SSH")
          
          async def restart_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
              user_id = update.effective_user.id
              if user_id == ADMIN_ID:
                  import subprocess
                  subprocess.run(['systemctl', 'restart', 'ssh'])
                  subprocess.run(['tailscale', 'up', '--reset'])
                  await update.message.reply_text("âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!")
              else:
                  await update.message.reply_text("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø±!")
          
          async def main():
              # Ø¥Ù†Ø´Ø§Ø¡ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨ÙˆØª
              application = Application.builder().token(TOKEN).build()
              
              # Ø¥Ø¶Ø§ÙØ© handlers
              application.add_handler(CommandHandler("start", start))
              application.add_handler(CommandHandler("help", help_command))
              application.add_handler(CommandHandler("status", status_command))
              application.add_handler(CommandHandler("ip", ip_command))
              application.add_handler(CommandHandler("ssh", ssh_command))
              application.add_handler(CommandHandler("restart", restart_command))
              
              # Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª
              await application.initialize()
              await application.start()
              await application.updater.start_polling()
              
              # Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„
              import asyncio
              await asyncio.Event().wait()
          
          if __name__ == '__main__':
              import asyncio
              asyncio.run(main())
          EOF
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø¨ÙˆØª
          cat << 'EOF' > requirements.txt
          python-telegram-bot==20.3
          psutil==5.9.6
          aiohttp==3.8.5
          asyncio==3.4.3
          EOF
          
          # ØªØ«Ø¨ÙŠØª Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø¨ÙˆØª
          pip3 install -r requirements.txt
          
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
          nohup python3 bot.py > /root/telegram_bot/bot.log 2>&1 &
          
          echo "ğŸ¤– Telegram Bot started successfully!"
          echo "Bot Token: 8541707577:AAHivkWH7RdHhKr8zXSuL_roy245LmNYyRo"
          echo "Admin ID: 7259620384"
          
      - name: Setup Auto-Reconnect Service
        run: |
          # Ø®Ø¯Ù…Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
          cat << 'EOF' > /root/auto_service.sh
          #!/bin/bash
          
          # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
          send_telegram() {
              local message="$1"
              curl -s -X POST "https://api.telegram.org/bot8541707577:AAHivkWH7RdHhKr8zXSuL_roy245LmNYyRo/sendMessage" \
                  -d "chat_id=7259620384" \
                  -d "text=$message" \
                  -d "parse_mode=Markdown"
          }
          
          # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¨Ø¯Ø¡
          send_telegram "ğŸš€ *VPS Started Successfully!*\\n\\nâœ… All services are running\\nğŸ“¦ All packages installed\\nğŸ¤– Bot is online\\n\\nUse /status to check server"
          
          while true; do
              # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Tailscale
              if ! tailscale status > /dev/null 2>&1; then
                  echo "[$(date)] Reconnecting Tailscale..."
                  sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --reset
                  send_telegram "ğŸ”Œ *Tailscale Reconnected*\\nNew IP: \`$(tailscale ip -4)\`"
              fi
              
              # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† SSH
              if ! systemctl is-active --quiet ssh; then
                  echo "[$(date)] Restarting SSH..."
                  sudo systemctl restart ssh
              fi
              
              # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙˆØª
              if ! pgrep -f "bot.py" > /dev/null; then
                  echo "[$(date)] Restarting Telegram Bot..."
                  cd /root/telegram_bot
                  nohup python3 bot.py > bot.log 2>&1 &
              fi
              
              # Ø¥Ø±Ø³Ø§Ù„ ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø³Ø§Ø¹Ø©
              if [ $(date +%M) == "00" ]; then
                  IP=$(tailscale ip -4)
                  UPTIME=$(uptime -p)
                  send_telegram "ğŸŸ¢ *Hourly Update*\\n\\nğŸŒ IP: \`$IP\`\\nâ° Uptime: $UPTIME\\nâœ… All systems normal"
              fi
              
              sleep 60
          done
          EOF
          
          chmod +x /root/auto_service.sh
          nohup /root/auto_service.sh > /root/service.log 2>&1 &
          
      - name: Final Setup & Display Info
        run: |
          echo " "
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘      âœ… VPS Setup Complete!         â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘ ğŸ“ Tailscale IP: $TAILSCALE_IP      â•‘"
          echo "â•‘ ğŸ” SSH User: root                   â•‘"
          echo "â•‘ ğŸ”‘ SSH Pass: Admin@Secure123        â•‘"
          echo "â•‘ ğŸ¤– Bot: @$(curl -s https://api.telegram.org/bot8541707577:AAHivkWH7RdHhKr8zXSuL_roy245LmNYyRo/getMe | jq -r '.result.username') â•‘"
          echo "â•‘ ğŸ‘¤ Admin ID: 7259620384             â•‘"
          echo "â•‘ â° Next auto-renew: 5 hours 50 min  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo " "
          
          # Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
          echo "ğŸ“‹ **Quick Connection Guide:**"
          echo "1. Connect via SSH:"
          echo "   ssh root@$TAILSCALE_IP"
          echo "   Password: Admin@Secure123"
          echo ""
          echo "2. Telegram Bot Commands:"
          echo "   /start - Start bot"
          echo "   /status - Server status"
          echo "   /ip - Get server IP"
          echo "   /ssh - SSH connection info"
          echo ""
          echo "3. Services running:"
          echo "   âœ… SSH Server"
          echo "   âœ… Tailscale VPN"
          echo "   âœ… Telegram Bot"
          echo "   âœ… Auto-reconnect service"
          
      - name: Keep VPS Running
        run: |
          # Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± Ù†Ø´Ø·Ø§Ù‹
          echo "â³ VPS will run for 350 minutes (5h 50m)"
          echo "ğŸ”„ Next session starts automatically before this ends"
          
          # Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙˆÙ‚Øª
          sleep 21000  # 350 Ø¯Ù‚ÙŠÙ‚Ø©
          
          # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
          curl -s -X POST "https://api.telegram.org/bot8541707577:AAHivkWH7RdHhKr8zXSuL_roy245LmNYyRo/sendMessage" \
              -d "chat_id=7259620384" \
              -d "text=ğŸ”„ *VPS Session Ending*\\n\\nNext session will start in 10 minutes\\nIP will remain the same\\n\\nNo action required - auto-renew enabled" \
              -d "parse_mode=Markdown"
          
          echo "âœ… Session completed. Next session starting soon..."
